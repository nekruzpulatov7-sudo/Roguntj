<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой профиль — Rogun.tj</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #f4f7f6; font-family: sans-serif; }
        .profile-header { background: white; padding: 30px 0; border-bottom: 1px solid #eee; margin-bottom: 30px; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-avatar { width: 80px; height: 80px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; }
        
        .my-ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .my-ad-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .my-ad-card img { width: 100%; height: 180px; object-fit: cover; }
        .my-ad-info { padding: 15px; flex-grow: 1; }
        .my-ad-title { font-weight: bold; margin-bottom: 10px; font-size: 16px; height: 40px; overflow: hidden; }
        
        .btn-delete { width: 100%; padding: 10px; background: #ff4d4d; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-delete:hover { background: #cc0000; }
        
        .btn-logout { background: #6c757d; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 14px; }
        .empty-state { text-align: center; padding: 50px; color: #888; }
    </style>
</head>
<body>

<header style="background: white; padding: 15px 0; border-bottom: 1px solid #eee;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <h1 onclick="location.href='index.html'" style="cursor:pointer; margin:0; font-size: 24px;">Rogun.tj</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="index.html" style="text-decoration: none; color: #007bff;">На главную</a>
            <button id="logout-btn" class="btn-logout">Выйти</button>
        </div>
    </div>
</header>

<div class="profile-header">
    <div class="container">
        <div class="user-info">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <h2 id="user-phone" style="margin:0;">Загрузка...</h2>
                <p style="color: #888; margin: 5px 0 0;">Ваши активные объявления</p>
            </div>
        </div>
    </div>
</div>

<main class="container">
    <div id="my-ads-container" class="my-ads-grid">
        </div>
</main>

<script type="module">
    import { getAds, saveAds, getCurrentUser, setCurrentUser } from './js/storage.js';

    const adsContainer = document.getElementById('my-ads-container');
    const userPhoneDisplay = document.getElementById('user-phone');
    const userInitialDisplay = document.getElementById('user-initial');
    const logoutBtn = document.getElementById('logout-btn');

    // 1. Проверка авторизации
    const user = getCurrentUser();
    if (!user) {
        window.location.href = 'login.html';
    } else {
        userPhoneDisplay.innerText = user.phone;
        userInitialDisplay.innerText = user.phone.substring(user.phone.length - 1);
    }

    // 2. Функция выхода
    logoutBtn.onclick = () => {
        if(confirm('Вы уверены, что хотите выйти?')) {
            localStorage.removeItem('currentUser'); // Очищаем сессию
            window.location.href = 'index.html';
        }
    };

    // 3. Отображение только МОИХ объявлений
    function renderMyAds() {
        const allAds = getAds() || [];
        
        // Фильтруем: оставляем только те, где ownerId совпадает с ID текущего пользователя
        // Или если ownerId равен 'guest', проверяем по номеру телефона
        const myAds = allAds.filter(ad => 
            ad.ownerId === user.id || ad.phone === user.phone
        );

        if (myAds.length === 0) {
            adsContainer.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <h3>У вас пока нет объявлений</h3>
                    <a href="add.html" class="btn-add-main" style="display:inline-block; margin-top:15px; text-decoration:none; background:#007bff; color:white; padding:10px 20px; border-radius:8px;">Разместить первое</a>
                </div>
            `;
            return;
        }

        adsContainer.innerHTML = '';
        myAds.forEach(ad => {
            const card = document.createElement('div');
            card.className = 'my-ad-card';
            const img = ad.images && ad.images.length > 0 ? ad.images[0] : 'https://via.placeholder.com/300x190';
            
            card.innerHTML = `
                <img src="${img}" alt="">
                <div class="my-ad-info">
                    <div class="my-ad-title">${ad.title}</div>
                    <div style="font-weight:bold; color:#28a745;">${Number(ad.price).toLocaleString()} TJS</div>
                </div>
                <button class="btn-delete" data-id="${ad.id}">Удалить объявление</button>
            `;
            adsContainer.appendChild(card);
        });

        // Вешаем событие на кнопки удаления
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = (e) => {
                const idToDelete = parseInt(e.target.dataset.id);
                deleteAd(idToDelete);
            };
        });
    }

    // 4. Функция удаления
    function deleteAd(id) {
        if (confirm('Вы точно хотите удалить это объявление?')) {
            const allAds = getAds();
            const updatedAds = allAds.filter(ad => ad.id !== id);
            saveAds(updatedAds);
            renderMyAds(); // Перерисовываем список
        }
    }

    renderMyAds();
</script>

</body>
</html>