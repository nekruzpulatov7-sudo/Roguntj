<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî Rogun.tj</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; margin: 0; transition: 0.3s; }
        body.dark-mode { background: #121225; color: white; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 0 15px; }
        
        /* –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-header { background: white; padding: 40px 0; border-bottom: 1px solid #eee; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .dark-mode .profile-header { background: #1f1f3a; border-bottom: 1px solid #333; }
        
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-avatar { 
            width: 80px; height: 80px; background: #007bff; color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 32px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,123,255,0.3); 
        }
        
        /* –°–µ—Ç–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π */
        .my-ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .my-ad-card { 
            background: white; border-radius: 15px; overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: 0.3s; 
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark-mode .my-ad-card { background: #1f1f3a; border-color: #333; }
        
        .my-ad-card img { width: 100%; height: 180px; object-fit: cover; }
        
        .my-ad-info { padding: 15px; flex-grow: 1; }
        .my-ad-title { font-weight: bold; margin-bottom: 8px; font-size: 16px; color: #333; height: 40px; overflow: hidden; }
        .dark-mode .my-ad-title { color: #eee; }
        .my-ad-price { font-size: 18px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .ad-actions { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid #eee; }
        .dark-mode .ad-actions { border-top: 1px solid #333; }
        
        .btn-action { padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; background: none; text-align: center; }
        .btn-edit { color: #007bff; border-right: 1px solid #eee; }
        .btn-edit:hover { background: #f0f7ff; }
        .dark-mode .btn-edit:hover { background: rgba(0,123,255,0.1); }
        
        .btn-delete { color: #ff4d4d; }
        .btn-delete:hover { background: #fff1f1; }
        .dark-mode .btn-delete:hover { background: rgba(255,77,77,0.1); }

        .btn-logout { background: #f8f9fa; color: #6c757d; padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #ff4757; color: white; border-color: #ff4757; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #888; background: white; border-radius: 20px; grid-column: 1/-1; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .dark-mode .empty-state { background: #1f1f3a; color: #aaa; }
    </style>
</head>
<body>

<header style="background: white; padding: 15px 0; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <h1 onclick="location.href='index.html'" style="cursor:pointer; margin:0; font-size: 24px; color: #007bff;">Rogun<span style="color:#28a745">.tj</span></h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="index.html" style="text-decoration: none; color: #007bff; font-weight: 500;">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <button id="logout-btn" class="btn-logout">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</header>

<div class="profile-header">
    <div class="container">
        <div class="user-info">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <h2 id="user-phone" style="margin:0; color: #333;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="user-status" style="color: #888; margin: 5px 0 0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞</p>
            </div>
        </div>
    </div>
</div>

<main class="container">
    <h3 style="margin-bottom: 25px; color: #333;" id="section-title">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
    <div id="my-ads-container" class="my-ads-grid">
        </div>
</main>

<script type="module">
    import { getAds, saveAds, getCurrentUser } from './js/storage.js';

    const adsContainer = document.getElementById('my-ads-container');
    const userPhoneDisplay = document.getElementById('user-phone');
    const userInitialDisplay = document.getElementById('user-initial');
    const logoutBtn = document.getElementById('logout-btn');

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = getCurrentUser();
    if (!user) {
        window.location.href = 'login.html';
    } else {
        userPhoneDisplay.innerText = user.phone || user.username;
        // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É –∫–æ–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏
        const cleanPhone = (user.phone || "").replace(/\D/g,'');
        userInitialDisplay.innerText = cleanPhone.length > 3 ? cleanPhone.charAt(3) : (user.username ? user.username.charAt(0).toUpperCase() : 'U');
    }

    // 2. –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    logoutBtn.onclick = () => {
        if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
            localStorage.removeItem('currentUser'); 
            window.location.href = 'index.html';
        }
    };

    // 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    function renderMyAds() {
        const allAds = getAds() || [];
        // –§–∏–ª—å—Ç—Ä—É–µ–º: —Ç–æ–ª—å–∫–æ —Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const myAds = allAds.filter(ad => ad.userId === user.id);

        if (myAds.length === 0) {
            adsContainer.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 50px; margin-bottom: 10px;">üì¶</div>
                    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤ –†–æ–≥—É–Ω–µ –∏ –ø–æ –≤—Å–µ–º—É –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω—É!</p>
                    <a href="add.html" style="display:inline-block; margin-top:15px; text-decoration:none; background:#007bff; color:white; padding:12px 25px; border-radius:10px; font-weight:bold;">+ –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
                </div>
            `;
            return;
        }

        adsContainer.innerHTML = '';
        myAds.sort((a, b) => b.id - a.id).forEach(ad => {
            const card = document.createElement('div');
            card.className = 'my-ad-card';
            const img = (ad.images && ad.images.length > 0) ? ad.images[0] : 'https://via.placeholder.com/300x190?text=–ù–µ—Ç+—Ñ–æ—Ç–æ';
            
            card.innerHTML = `
                <img src="${img}" alt="${ad.title}">
                <div class="my-ad-info">
                    <div class="my-ad-price">${Number(ad.price).toLocaleString()} TJS</div>
                    <div class="my-ad-title">${ad.title}</div>
                </div>
                <div class="ad-actions">
                    <button class="btn-action btn-edit" data-id="${ad.id}">‚úèÔ∏è –¶–µ–Ω–∞</button>
                    <button class="btn-action btn-delete" data-id="${ad.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            adsContainer.appendChild(card);
        });

        setupListeners();
    }

    // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
    function setupListeners() {
        // –£–¥–∞–ª–µ–Ω–∏–µ
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = (e) => {
                const id = parseInt(btn.getAttribute('data-id'));
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
                    const allAds = getAds();
                    const filtered = allAds.filter(ad => ad.id !== id);
                    saveAds(filtered);
                    renderMyAds();
                }
            };
        });

        // –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.onclick = (e) => {
                const id = parseInt(btn.getAttribute('data-id'));
                const allAds = getAds();
                const adIndex = allAds.findIndex(a => a.id === id);
                const ad = allAds[adIndex];
                
                const newPrice = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –¥–ª—è "${ad.title}":`, ad.price);
                
                if (newPrice !== null && !isNaN(newPrice) && newPrice.trim() !== "") {
                    allAds[adIndex].price = newPrice.trim();
                    saveAds(allAds);
                    renderMyAds();
                }
            };
        });
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
    if(localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.querySelector('header').style.background = '#1a1a2e';
        document.querySelector('header').style.borderColor = '#333';
    }

    renderMyAds();
</script>

</body>
</html>