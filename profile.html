<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî Rogun.tj</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; transition: 0.3s; }
        body.dark-mode { background: #121225; color: white; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 0 15px; }
        
        /* –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-header { background: white; padding: 40px 0; border-bottom: 1px solid #eee; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .dark-mode .profile-header { background: #1f1f3a; border-bottom: 1px solid #333; }
        
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-avatar { width: 80px; height: 80px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,123,255,0.3); }
        
        /* –°–µ—Ç–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π */
        .my-ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .my-ad-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: 0.3s; }
        .dark-mode .my-ad-card { background: #1f1f3a; }
        .my-ad-card:hover { transform: translateY(-5px); }
        .my-ad-card img { width: 100%; height: 180px; object-fit: cover; }
        
        .my-ad-info { padding: 15px; flex-grow: 1; }
        .my-ad-title { font-weight: bold; margin-bottom: 8px; font-size: 16px; color: #333; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 40px; }
        .dark-mode .my-ad-title { color: #eee; }
        .my-ad-price { font-size: 18px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-delete { width: 100%; padding: 12px; background: #fff1f1; color: #ff4d4d; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; border-top: 1px solid #ffebeb; }
        .btn-delete:hover { background: #ff4d4d; color: white; }
        .dark-mode .btn-delete { background: #2d1a1a; border-top: 1px solid #442222; }
        
        .btn-logout { background: #f8f9fa; color: #6c757d; padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .btn-logout:hover { background: #e2e6ea; color: #333; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #888; background: white; border-radius: 20px; grid-column: 1/-1; }
        .dark-mode .empty-state { background: #1f1f3a; }
        
        header h1 { color: #007bff; transition: 0.3s; }
    </style>
</head>
<body>

<header style="background: white; padding: 15px 0; border-bottom: 1px solid #eee;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <h1 onclick="location.href='index.html'" style="cursor:pointer; margin:0; font-size: 24px;">Rogun<span style="color:#28a745">.tj</span></h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="index.html" style="text-decoration: none; color: #007bff; font-weight: 500;">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <button id="logout-btn" class="btn-logout">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</header>

<div class="profile-header">
    <div class="container">
        <div class="user-info">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <h2 id="user-phone" style="margin:0; color: #333;">+992 ...</h2>
                <p id="user-status" style="color: #888; margin: 5px 0 0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞</p>
            </div>
        </div>
    </div>
</div>

<main class="container">
    <h3 style="margin-bottom: 25px; color: #333;" id="section-title">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
    <div id="my-ads-container" class="my-ads-grid">
        </div>
</main>

<script type="module">
    import { getAds, saveAds, getCurrentUser } from './js/storage.js';

    const adsContainer = document.getElementById('my-ads-container');
    const userPhoneDisplay = document.getElementById('user-phone');
    const userInitialDisplay = document.getElementById('user-initial');
    const logoutBtn = document.getElementById('logout-btn');

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = getCurrentUser();
    if (!user) {
        window.location.href = 'login.html';
    } else {
        userPhoneDisplay.innerText = user.phone;
        // –ö—Ä–∞—Å–∏–≤–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞: –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É –Ω–æ–º–µ—Ä–∞ –∏–ª–∏ –±—É–∫–≤—É
        userInitialDisplay.innerText = user.phone.charAt(0).toUpperCase();
    }

    // 2. –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    logoutBtn.onclick = () => {
        if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
            localStorage.removeItem('currentUser'); 
            window.location.href = 'index.html';
        }
    };

    // 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function renderMyAds() {
        const allAds = getAds() || [];
        
        // –í–ê–ñ–ù–û: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ userId (–∫–∞–∫ –≤ add.html)
        const myAds = allAds.filter(ad => ad.userId === user.id);

        if (myAds.length === 0) {
            adsContainer.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 50px; margin-bottom: 10px;">üì¶</div>
                    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h3>
                    <p>–ü—Ä–æ–¥–∞–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</p>
                    <a href="add.html" style="display:inline-block; margin-top:15px; text-decoration:none; background:#007bff; color:white; padding:12px 25px; border-radius:10px; font-weight:bold;">+ –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
                </div>
            `;
            return;
        }

        adsContainer.innerHTML = '';
        myAds.sort((a, b) => b.id - a.id).forEach(ad => {
            const card = document.createElement('div');
            card.className = 'my-ad-card';
            const img = (ad.images && ad.images.length > 0) ? ad.images[0] : 'https://via.placeholder.com/300x190?text=–ù–µ—Ç+—Ñ–æ—Ç–æ';
            
            card.innerHTML = `
                <img src="${img}" alt="${ad.title}">
                <div class="my-ad-info">
                    <div class="my-ad-price">${Number(ad.price).toLocaleString()} TJS</div>
                    <div class="my-ad-title">${ad.title}</div>
                </div>
                <button class="btn-delete" data-id="${ad.id}">–£–¥–∞–ª–∏—Ç—å</button>
            `;
            adsContainer.appendChild(card);
        });

        // –°–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = (e) => {
                const idToDelete = parseInt(e.target.dataset.id);
                deleteAd(idToDelete);
            };
        });
    }

    // 4. –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    function deleteAd(id) {
        if (confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å. –£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) {
            const allAds = getAds();
            const updatedAds = allAds.filter(ad => ad.id !== id);
            saveAds(updatedAds); // –ò—Å–ø–æ–ª—å–∑—É–µ–º saveAds –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –±–∞–∑—ã
            renderMyAds(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
        }
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
    if(localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
    }

    renderMyAds();
</script>

</body>
</html>