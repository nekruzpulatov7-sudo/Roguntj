<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî Rogun.tj</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { 
            background: #f4f7f6; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            transition: 0.3s; 
            color: #333; 
            padding-bottom: 80px; 
        }
        body.dark-mode { background: #121225; color: white; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 0 15px; }
        
        /* –®–∞–ø–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        header { 
            background: white; 
            padding: 15px 0; 
            border-bottom: 1px solid #eee; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            transition: 0.3s; 
        }
        .dark-mode header { background: #1a1a2e; border-color: #333; }
        
        /* –°–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .profile-header { 
            background: white; 
            padding: 40px 0; 
            border-bottom: 1px solid #eee; 
            margin-bottom: 30px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); 
            transition: 0.3s; 
        }
        .dark-mode .profile-header { background: #1f1f3a; border-bottom: 1px solid #333; }
        
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-avatar { 
            width: 80px; height: 80px; background: #007bff; color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 32px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,123,255,0.3); 
        }
        
        /* –°–µ—Ç–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π */
        .my-ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .my-ad-card { 
            background: white; border-radius: 15px; overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: 0.3s; 
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark-mode .my-ad-card { background: #1a1a2e; border-color: #333; }
        
        .my-ad-card img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; }
        
        .my-ad-info { padding: 15px; flex-grow: 1; }
        .my-ad-title { font-weight: bold; margin-bottom: 8px; font-size: 16px; height: 40px; overflow: hidden; }
        .my-ad-price { font-size: 18px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .ad-actions { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid #eee; }
        .dark-mode .ad-actions { border-top: 1px solid #333; }
        
        .btn-action { padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; background: none; text-align: center; color: inherit; }
        .btn-edit { color: #007bff; border-right: 1px solid #eee; }
        .dark-mode .btn-edit { border-right: 1px solid #333; }
        .btn-edit:hover { background: #f0f7ff; }
        
        .btn-delete { color: #ff4d4d; }
        .btn-delete:hover { background: #fff1f1; }

        .btn-logout { background: #f8f9fa; color: #6c757d; padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #ff4757; color: white; border-color: #ff4757; }
        
        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 20px; grid-column: 1/-1; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .dark-mode .empty-state { background: #1f1f3a; color: #aaa; }

        /* –ú–û–ë–ò–õ–¨–ù–û–ï –ú–ï–ù–Æ */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: white; display: flex; justify-content: space-around;
            align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        .dark-mode .mobile-nav { background: #1a1a2e; border-top: 1px solid #333; }
        .nav-item { text-decoration: none; color: #888; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: 600; }
        .nav-item span:first-child { font-size: 22px; margin-bottom: 2px; }
        .nav-item.active { color: #007bff; }
        .add-icon-circle { 
            width: 55px; height: 55px; background: #28a745; color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 24px; margin-top: -35px; border: 5px solid #f4f7f6;
            box-shadow: 0 4px 10px rgba(40,167,69,0.3);
        }
        .dark-mode .add-icon-circle { border-color: #121225; }

        @media (max-width: 600px) {
            .my-ads-grid { grid-template-columns: 1fr; }
            .profile-header { padding: 25px 0; }
        }
    </style>
</head>
<body>

<header>
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <h1 onclick="location.href='index.html'" style="cursor:pointer; margin:0; font-size: 24px; color: #007bff;">Rogun<span style="color:#28a745">.tj</span></h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button id="logout-btn" class="btn-logout">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</header>

<div class="profile-header">
    <div class="container">
        <div class="user-info">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <h2 id="user-phone" style="margin:0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="user-status" style="color: #888; margin: 5px 0 0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞</p>
            </div>
        </div>
    </div>
</div>

<main class="container">
    <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
        üì¶ –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    </h3>
    <div id="my-ads-container" class="my-ads-grid">
        </div>
</main>

<div class="mobile-nav">
    <a href="index.html" class="nav-item">
        <span>üè†</span>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="profile.html?tab=favs" class="nav-item">
        <span>‚ù§Ô∏è</span>
        <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
    </a>
    <a href="add.html" class="nav-item">
        <div class="add-icon-circle">‚ûï</div>
    </a>
    <a href="profile.html" class="nav-item active">
        <span>üë§</span>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
</div>

<script type="module">
    import { getAds, saveAds, getCurrentUser, logout } from './js/storage.js';

    const adsContainer = document.getElementById('my-ads-container');
    const userPhoneDisplay = document.getElementById('user-phone');
    const userInitialDisplay = document.getElementById('user-initial');
    const logoutBtn = document.getElementById('logout-btn');

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = getCurrentUser();
    if (!user) {
        window.location.href = 'index.html'; 
    } else {
        userPhoneDisplay.innerText = user.phone || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        const name = (user.phone || "U");
        userInitialDisplay.innerText = name.charAt(0).toUpperCase();
    }

    // 2. –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
    }

    // 3. –í—ã—Ö–æ–¥
    logoutBtn.onclick = () => {
        if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            logout();
        }
    };

    // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    function renderMyAds() {
        const allAds = getAds();
        // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const myAds = allAds.filter(ad => String(ad.userId) === String(user.id));

        if (myAds.length === 0) {
            adsContainer.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 50px; margin-bottom: 10px;">üì¶</div>
                    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h3>
                    <p>–ü—Ä–æ–¥–∞–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è!</p>
                    <a href="add.html" style="display:inline-block; margin-top:15px; text-decoration:none; background:#28a745; color:white; padding:12px 25px; border-radius:10px; font-weight:bold;">–ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
                </div>
            `;
            return;
        }

        adsContainer.innerHTML = '';
        myAds.sort((a, b) => b.id - a.id).forEach(ad => {
            const card = document.createElement('div');
            card.className = 'my-ad-card';
            const mainImg = (ad.images && ad.images.length > 0) ? ad.images[0] : 'https://via.placeholder.com/300x190?text=–ù–µ—Ç+—Ñ–æ—Ç–æ';
            
            card.innerHTML = `
                <img src="${mainImg}" alt="${ad.title}" onclick="location.href='detail.html?id=${ad.id}'">
                <div class="my-ad-info">
                    <div class="my-ad-price">${Number(ad.price).toLocaleString()} TJS</div>
                    <div class="my-ad-title">${ad.title}</div>
                </div>
                <div class="ad-actions">
                    <button class="btn-action btn-edit" data-id="${ad.id}">‚úèÔ∏è –°–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É</button>
                    <button class="btn-action btn-delete" data-id="${ad.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            adsContainer.appendChild(card);
        });

        attachActionListeners();
    }

    // 5. –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function attachActionListeners() {
        // –£–¥–∞–ª–µ–Ω–∏–µ
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = () => {
                const id = parseInt(btn.dataset.id);
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
                    const allAds = getAds().filter(ad => ad.id !== id);
                    saveAds(allAds);
                    renderMyAds();
                }
            };
        });

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.onclick = () => {
                const id = parseInt(btn.dataset.id);
                const allAds = getAds();
                const adIndex = allAds.findIndex(a => a.id === id);
                
                const currentPrice = allAds[adIndex].price;
                const newPrice = prompt(`–£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –¥–ª—è "${allAds[adIndex].title}":`, currentPrice);
                
                if (newPrice !== null && !isNaN(newPrice) && newPrice.trim() !== "") {
                    allAds[adIndex].price = newPrice.trim();
                    saveAds(allAds);
                    renderMyAds();
                }
            };
        });
    }

    renderMyAds();
</script>

</body>
</html>