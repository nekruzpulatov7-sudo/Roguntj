<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ‚Äî Rogun.tj</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #f4f7f6; font-family: sans-serif; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        #image-preview { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        #image-preview img { width: 85px; height: 85px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
        .btn-submit { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 15px; transition: 0.3s; }
        .btn-submit:hover { background: #218838; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 14px; color: #555; }
        header h2 { margin: 0; }
        optgroup { font-style: normal; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

<header style="background: white; border-bottom: 1px solid #eee; padding: 15px 0; margin-bottom: 20px;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 onclick="location.href='index.html'" style="cursor:pointer; color:#007bff;">Rogun.tj</h2>
        <a href="index.html" style="text-decoration:none; color: #666;">‚Üê –û—Ç–º–µ–Ω–∞</a>
    </div>
</header>

<main class="container">
    <div class="card">
        <h3 style="margin-top:0;">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
        <form id="add-form">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
            <input type="text" id="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: iPhone 13 Pro Max" required>
            
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="category" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                <option value="–ü—Ä–æ–¥—É–∫—Ç—ã">üçé –ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è</option>
                <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ –∏ –¢–µ—Ö–Ω–∏–∫–∞</option>
                <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–ê–≤—Ç–æ)</option>
                <option value="–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å">üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                <option value="–û–¥–µ–∂–¥–∞">üëï –û–¥–µ–∂–¥–∞ –∏ –û–±—É–≤—å</option>
                <option value="–î–ª—è –¥–æ–º–∞">üõãÔ∏è –í—Å–µ –¥–ª—è –¥–æ–º–∞</option>
                <option value="–£—Å–ª—É–≥–∏">üõ†Ô∏è –£—Å–ª—É–≥–∏</option>
                <option value="–†–∞–±–æ—Ç–∞">üíº –†–∞–±–æ—Ç–∞ –∏ –í–∞–∫–∞–Ω—Å–∏–∏</option>
            </select>

            <label>–¶–µ–Ω–∞ (TJS)</label>
            <input type="number" id="price" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É" required>

            <label>–†–µ–≥–∏–æ–Ω / –ì–æ—Ä–æ–¥</label>
            <select id="region" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</option>
                <optgroup label="–û—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞">
                    <option value="–î—É—à–∞–Ω–±–µ">–î—É—à–∞–Ω–±–µ</option>
                    <option value="–•—É–¥–∂–∞–Ω–¥">–•—É–¥–∂–∞–Ω–¥</option>
                    <option value="–ë–æ—Ö—Ç–∞—Ä">–ë–æ—Ö—Ç–∞—Ä</option>
                    <option value="–ö—É–ª—è–±">–ö—É–ª—è–±</option>
                    <option value="–†–æ–≥—É–Ω">–†–æ–≥—É–Ω</option>
                </optgroup>
                <optgroup label="–†–∞–π–æ–Ω—ã">
                    <option value="–í–∞—Ö–¥–∞—Ç">–í–∞—Ö–¥–∞—Ç</option>
                    <option value="–§–∞–π–∑–æ–±–æ–¥">–§–∞–π–∑–æ–±–æ–¥</option>
                    <option value="–†—É–¥–∞–∫–∏">–†—É–¥–∞–∫–∏</option>
                </optgroup>
            </select>

            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description" rows="4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ç–æ–≤–∞—Ä–µ..."></textarea>

            <label>–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
            <input type="tel" id="phone" value="+992" required>

            <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5 —à—Ç—É–∫)</label>
            <input type="file" id="images" multiple accept="image/*">
            <div id="image-preview"></div>

            <div id="message" style="text-align:center; font-weight:bold; margin-top:15px; min-height: 20px;"></div>
            <button type="submit" class="btn-submit" id="submit-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </form>
    </div>
</main>

<script type="module">
    import { getAds, saveAds, getCurrentUser } from './js/storage.js';

    const form = document.getElementById('add-form');
    const imageInput = document.getElementById('images');
    const preview = document.getElementById('image-preview');
    const phoneInput = document.getElementById('phone');
    const submitBtn = document.getElementById('submit-btn');
    
    // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –≤–æ—à–µ–ª
    const user = getCurrentUser();
    if (user) {
        phoneInput.value = user.phone || '+992';
    }

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
    imageInput.onchange = () => {
        preview.innerHTML = '';
        const files = Array.from(imageInput.files).slice(0, 5);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    };

    async function compressImage(base64) {
        return new Promise(resolve => {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 500; 
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.6)); 
            };
        });
    }

    form.onsubmit = async (e) => {
        e.preventDefault();
        
        // –ï—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –≤–æ—à–µ–ª, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω
        if (!user) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.");
            window.location.href = 'login.html';
            return;
        }

        submitBtn.disabled = true;
        const msg = document.getElementById('message');
        msg.style.color = "#333";
        msg.innerText = "–ü—É–±–ª–∏–∫–∞—Ü–∏—è...";

        try {
            const files = Array.from(imageInput.files).slice(0, 5);
            const compressedImages = [];

            for (const file of files) {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = ev => r(ev.target.result);
                    reader.readAsDataURL(file);
                });
                const compressed = await compressImage(base64);
                compressedImages.push(compressed);
            }

            const newAd = {
                id: Date.now(),
                ownerId: user.id,
                title: document.getElementById('title').value,
                price: Number(document.getElementById('price').value),
                phone: phoneInput.value,
                region: document.getElementById('region').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                images: compressedImages.length > 0 ? compressedImages : ['https://via.placeholder.com/300x190?text=–ù–µ—Ç+—Ñ–æ—Ç–æ'],
                createdAt: new Date().toLocaleDateString('ru-RU')
            };

            const ads = getAds();
            ads.unshift(newAd);
            saveAds(ads);
            
            msg.style.color = "green";
            msg.innerText = "–£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!";
            setTimeout(() => window.location.href = 'index.html', 1000);

        } catch(error) {
            msg.style.color = "red";
            msg.innerText = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.";
            submitBtn.disabled = false;
        }
    };
</script>
</body>
</html>