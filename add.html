<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавить объявление — Rogun.tj</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        #add-form input, #add-form select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        #image-preview { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
        #image-preview img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .btn-submit { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; }
        .btn-submit:hover { background: #218838; }
        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
        label { font-weight: bold; display: block; margin-top: 15px; color: #555; }
        .form-message { margin-top: 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="header-container">
            <h1 onclick="location.href='index.html'" style="cursor:pointer; margin:0;">Rogun.tj</h1>
            <a href="index.html" style="text-decoration: none; color: #007bff; font-weight: bold;">← На главную</a>
        </div>
    </div>
</header>

<main class="container">
    <form id="add-form">
        <h2 style="text-align: center;">Новое объявление</h2>
        
        <label>Название товара или услуги</label>
        <input type="text" id="title" placeholder="Например: Продаю iPhone 13" required>
        
        <label>Цена (TJS)</label>
        <input type="number" id="price" placeholder="Укажите цену" required>
        
        <label>Номер телефона</label>
        <input type="tel" id="phone" placeholder="900112233" required>

        <label>Регион</label>
        <select id="region" required>
            <option value="">Выберите город / район</option>
            <option value="Рогун">Рогун</option>
            <option value="Душанбе">Душанбе</option>
            <option value="Худжанд">Худжанд</option>
            <option value="Бохтар">Бохтар</option>
            <option value="Нурек">Нурек</option>
            <option value="Вахдат">Вахдат</option>
        </select>

        <label>Категория</label>
        <select id="category" required>
            <option value="">Выберите категорию</option>
            <option value="Продуктовый Магазин">Продукты</option>
            <option value="Услуги и Вакансии">Услуги</option>
            <option value="Электроника и Бытовая Техника">Электроника</option>
            <option value="Магазин Одежда">Одежда</option>
            <option value="Все для Дома">Все для Дома</option>
        </select>

        <label>Добавить фото (макс. 5)</label>
        <input type="file" id="images" multiple accept="image/*" style="border: none; padding: 10px 0;">
        <div id="image-preview"></div>

        <div id="message" class="form-message"></div>
        <button type="submit" class="btn-submit">Опубликовать бесплатно</button>
    </form>
</main>

<script type="module">
    import { getAds, saveAds, getCurrentUser } from './js/storage.js';

    const form = document.getElementById('add-form');
    const imageInput = document.getElementById('images');
    const preview = document.getElementById('image-preview');

    // Если пользователь вошел, автоматически ставим его номер
    const user = getCurrentUser();
    if (user && user.phone) {
        document.getElementById('phone').value = user.phone;
    }

    imageInput.addEventListener('change', () => {
        preview.innerHTML = '';
        const files = Array.from(imageInput.files).slice(0, 5);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    async function compressImage(base64) {
        return new Promise(resolve => {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 800; 
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.7)); 
            };
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msgDiv = document.getElementById('message');
        msgDiv.style.color = 'blue';
        msgDiv.innerText = 'Публикация...';

        const files = Array.from(imageInput.files).slice(0, 5);
        const compressedImages = [];

        for (const file of files) {
            const base64 = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = ev => r(ev.target.result);
                reader.readAsDataURL(file);
            });
            const compressed = await compressImage(base64);
            compressedImages.push(compressed);
        }

        const newAd = {
            id: Date.now(),
            ownerId: user ? user.id : 'guest',
            title: document.getElementById('title').value,
            price: Number(document.getElementById('price').value),
            phone: document.getElementById('phone').value,
            region: document.getElementById('region').value,
            category: document.getElementById('category').value,
            images: compressedImages.length > 0 ? compressedImages : ['https://via.placeholder.com/300x190?text=Нет+фото'],
            createdAt: new Date().toLocaleDateString('ru-RU')
        };

        const ads = getAds() || [];
        ads.push(newAd);
        
        try {
            saveAds(ads);
            msgDiv.style.color = 'green';
            msgDiv.innerText = 'Успешно!';
            setTimeout(() => window.location.href = 'index.html', 1000);
        } catch (err) {
            msgDiv.style.color = 'red';
            msgDiv.innerText = 'Слишком тяжелые фото!';
        }
    });
</script>
</body>
</html>