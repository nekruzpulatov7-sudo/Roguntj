<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogun.tj ‚Äî –ú–∞–≥–∞–∑–∏–Ω –æ–±—ä—è–≤–ª–µ–Ω–∏–π</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .dark-mode { background-color: #1a1a1a; color: white; }
        .dark-mode .product-card { background: #2d2d2d; color: white; border: 1px solid #444; }
        .dark-mode header, .dark-mode footer { background: #111; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .product-card { border: 1px solid #ddd; border-radius: 12px; overflow: hidden; position: relative; transition: 0.3s; cursor: pointer; background: white; color: #333; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .product-card img { width: 100%; height: 160px; object-fit: cover; }
        .product-card .info { padding: 12px; }
        .product-card .price { font-size: 18px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
        .product-card .title { font-size: 14px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-card .category-tag { font-size: 11px; color: #888; }
        .product-card .region-tag { font-size: 11px; color: #007bff; float: right; }
        
        .cat-nav { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .cat-nav::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; cursor: pointer; background: white; white-space: nowrap; font-size: 14px; flex-shrink: 0; }
        .cat-btn.active { background: #007bff; color: white; border-color: #007bff; }
        
        .btn-add-main { background: #007bff; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; }
        #user-menu a { text-decoration: none; color: #007bff; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <h1 onclick="location.href='index.html'" style="cursor:pointer; margin:0; color:#007bff;">Rogun.tj</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="user-menu"></div> 
            <button id="theme-toggle" style="cursor:pointer; border:none; background:none; font-size:20px;">üåô</button>
        </div>
    </div>
</header>

<section style="background: #f8f9fa; padding: 15px 0; border-bottom: 1px solid #eee;">
    <div class="container">
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <input type="text" id="search-input" placeholder="–ß—Ç–æ –∏—â–µ–º?" style="padding: 12px; flex: 2; border-radius: 8px; border: 1px solid #ddd;">
            
            <select id="region-filter" style="padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="">–í–µ—Å—å –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</option>
                <optgroup label="–û—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞">
                    <option value="–î—É—à–∞–Ω–±–µ">–î—É—à–∞–Ω–±–µ</option>
                    <option value="–•—É–¥–∂–∞–Ω–¥">–•—É–¥–∂–∞–Ω–¥</option>
                    <option value="–ë–æ—Ö—Ç–∞—Ä">–ë–æ—Ö—Ç–∞—Ä</option>
                    <option value="–ö—É–ª—è–±">–ö—É–ª—è–±</option>
                    <option value="–†–æ–≥—É–Ω">–†–æ–≥—É–Ω</option>
                    <option value="–ò—Å—Ç–∞—Ä–∞–≤—à–∞–Ω">–ò—Å—Ç–∞—Ä–∞–≤—à–∞–Ω</option>
                    <option value="–ù–æ—Ä–∞–∫">–ù–æ—Ä–∞–∫</option>
                    <option value="–•–∏—Å–æ—Ä">–•–∏—Å–æ—Ä</option>
                </optgroup>
                <optgroup label="–†–∞–π–æ–Ω—ã –†–†–ü –∏ –¥—Ä.">
                    <option value="–ê.–ß–æ–º–∏">–ê. –ß–æ–º–∏</option>
                    <option value="–ê–π–Ω–∏">–ê–π–Ω–∏</option>
                    <option value="–ê—à—Ç">–ê—à—Ç</option>
                    <option value="–ë–∞–ª—á—É–≤–æ–Ω">–ë–∞–ª—á—É–≤–æ–Ω</option>
                    <option value="–í–∞–Ω—á">–í–∞–Ω—á</option>
                    <option value="–í–∞—Ä–∑–æ–±">–í–∞—Ä–∑–æ–±</option>
                    <option value="–í–∞—Ö–¥–∞—Ç">–í–∞—Ö–¥–∞—Ç</option>
                    <option value="–í–∞—Ö—à">–í–∞—Ö—à</option>
                    <option value="–í–æ—Å–µ—ä">–í–æ—Å–µ—ä</option>
                    <option value="–î–∞–Ω–≥–∞—Ä–∞">–î–∞–Ω–≥–∞—Ä–∞</option>
                    <option value="–î—É—Å—Ç–∏">–î—É—Å—Ç–∏</option>
                    <option value="–ù—É—Ä–æ–±–æ–¥">–ù—É—Ä–æ–±–æ–¥</option>
                    <option value="–§–∞–π–∑–æ–±–æ–¥">–§–∞–π–∑–æ–±–æ–¥</option>
                    <option value="–•–æ—Ä—É–≥">–•–æ—Ä—É–≥</option>
                    <option value="–®–∞—Ö—Ä–∏–Ω–∞–≤">–®–∞—Ö—Ä–∏–Ω–∞–≤</option>
                </optgroup>
            </select>
            
            <a href="add.html" class="btn-add-main">+ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å</a>
        </div>
        
        <nav class="cat-nav" id="category-filter-container">
            <button class="cat-btn active" data-cat="">–í—Å–µ</button>
            <button class="cat-btn" data-cat="–ü—Ä–æ–¥—É–∫—Ç—ã">üçé –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="cat-btn" data-cat="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">üì± –¢–µ—Ö–Ω–∏–∫–∞</button>
            <button class="cat-btn" data-cat="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –ê–≤—Ç–æ</button>
            <button class="cat-btn" data-cat="–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å">üè† –ñ–∏–ª—å–µ</button>
            <button class="cat-btn" data-cat="–û–¥–µ–∂–¥–∞">üëï –û–¥–µ–∂–¥–∞</button>
            <button class="cat-btn" data-cat="–î–ª—è –¥–æ–º–∞">üõãÔ∏è –î–æ–º</button>
            <button class="cat-btn" data-cat="–£—Å–ª—É–≥–∏">üõ†Ô∏è –£—Å–ª—É–≥–∏</button>
            <button class="cat-btn" data-cat="–†–∞–±–æ—Ç–∞">üíº –†–∞–±–æ—Ç–∞</button>
        </nav>
    </div>
</section>

<main class="container">
    <div id="ads-container" class="ads-grid"></div>
</main>

<script type="module">
    import { getAds, getCurrentUser } from './js/storage.js';

    const adsContainer = document.getElementById('ads-container');
    const searchInput = document.getElementById('search-input');
    const regionFilter = document.getElementById('region-filter');
    const userMenu = document.getElementById('user-menu');
    const themeBtn = document.getElementById('theme-toggle');
    const catButtons = document.querySelectorAll('.cat-btn');

    function renderUserMenu() {
        const user = getCurrentUser();
        if (user) {
            userMenu.innerHTML = `<a href="profile.html">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>`;
        } else {
            userMenu.innerHTML = `<a href="login.html">–í–æ–π—Ç–∏</a>`;
        }
    }

    function updateAds() {
        const allAds = getAds() || [];
        const searchText = searchInput.value.toLowerCase();
        const selectedRegion = regionFilter.value;
        const activeBtn = document.querySelector('.cat-btn.active');
        const selectedCategory = activeBtn ? activeBtn.dataset.cat : "";

        const filtered = allAds.filter(ad => {
            const matchesSearch = ad.title.toLowerCase().includes(searchText);
            const matchesRegion = !selectedRegion || ad.region === selectedRegion;
            const matchesCategory = !selectedCategory || ad.category === selectedCategory;
            return matchesSearch && matchesRegion && matchesCategory;
        });

        adsContainer.innerHTML = '';
        if (filtered.length === 0) {
            adsContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 50px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
            return;
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
        filtered.sort((a, b) => b.id - a.id).forEach(ad => {
            const imageSrc = ad.images && ad.images.length > 0 ? ad.images[0] : 'https://via.placeholder.com/300x190';
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${imageSrc}">
                <div class="info">
                    <div class="price">${Number(ad.price).toLocaleString()} TJS</div>
                    <div class="title">${ad.title}</div>
                    <span class="category-tag">${ad.category}</span>
                    <span class="region-tag">üìç ${ad.region || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                </div>
            `;
            card.onclick = () => window.location.href = `detail.html?id=${ad.id}`;
            adsContainer.appendChild(card);
        });
    }

    catButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            catButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateAds();
        });
    });

    searchInput.addEventListener('input', updateAds);
    regionFilter.addEventListener('change', updateAds);
    
    themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        themeBtn.textContent = document.body.classList.contains('dark-mode') ? "‚òÄÔ∏è" : "üåô";
        // –°–æ—Ö—Ä–∞–Ω–∏–º –≤—ã–±–æ—Ä —Ç–µ–º—ã
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if(localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeBtn.textContent = "‚òÄÔ∏è";
    }

    renderUserMenu();
    updateAds();
</script>
</body>
</html>