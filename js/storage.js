/**
 * Rogun.tj - Модуль управления данными (LocalStorage)
 * Версия: 3.0 (Полная структура категорий SomonStyle + Методы управления)
 */

// 1. ПОЛНАЯ СТРУКТУРА КАТЕГОРИЙ (База данных рубрик для выпадающих списков)
export const SOMON_STRUCTURE = {
    "Транспорт": {
        "Легковые автомобили": ["Mercedes-Benz", "Opel", "Toyota", "Hyundai", "BMW", "LADA", "Kia", "Honda", "Nexia"],
        "Грузовики": ["Kamaz", "DAF", "Volvo", "Hyundai", "ZIL"],
        "Запчасти и аксессуары": ["Шины", "Двигатели", "Аккумуляторы", "Масла"]
    },
    "Недвижимость": {
        "Продажа квартир": ["1-комнатная", "2-комнатная", "3-комнатная", "Новостройка"],
        "Аренда квартир": ["На долгий срок", "Посуточно"],
        "Дома и Дачи": ["Продажа", "Аренда"],
        "Земля": ["Для бизнеса", "Для жилья"]
    },
    "Компьютеры и Оргтехника": {
        "Ноутбуки": ["Apple MacBook", "HP", "Acer", "Asus", "Lenovo"],
        "Настольные ПК": ["Игровые", "Для офиса"],
        "Принтеры и МФУ": ["Canon", "HP", "Epson"],
        "Комплектующие": ["Видеокарты", "Процессоры", "SSD"]
    },
    "Бытовая техника и Электроника": {
        "Телефоны": ["iPhone", "Samsung", "Xiaomi", "Redmi"],
        "Телевизоры": ["Samsung", "LG", "Sony", "Artel"],
        "Холодильники": ["Beko", "LG", "Indesit"],
        "Стиральные машины": ["Samsung", "Bosch", "LG"]
    },
    "Услуги": {
        "Транспортные услуги": ["Такси", "Грузоперевозки"],
        "Обучение": ["Репетиторы", "Курсы", "Автошкола"],
        "Бытовые услуги": ["Чистка ковров", "Уборка"]
    },
    "Работа": {
        "Резюме": ["Ищу работу"],
        "Подработка": ["Для студентов", "Временная"]
    },
    "Вакансия": {
        "Сфера продаж": ["Менеджер", "Продавец"],
        "IT": ["Разработчик", "Дизайнер"],
        "Строительство": ["Мастер", "Разнорабочий"]
    },
    "Все для дома": {
        "Мебель": ["Кровати", "Диваны", "Шкафы", "Столы"],
        "Декор": ["Ковры", "Шторы", "Люстры"]
    },
    "Рестораны и Гостиницы": {
        "Рестораны и кафе": ["Аренда зала", "Доставка еды"],
        "Гостиницы": ["Отели", "Хостелы", "Зоны отдыха"]
    },
    "Одежда и Обувь": {
        "Мужская": ["Костюмы", "Обувь", "Верхняя одежда"],
        "Женская": ["Платья", "Сумки", "Обувь"],
        "Аксессуары": ["Часы", "Очки", "Ремни"]
    },
    "Продукты": {
        "Напитки": ["Соки", "Вода"],
        "Овощи и Фрукты": ["Оптом", "В розницу"],
        "Сладости": ["Торты", "Конфеты"]
    },
    "Животные и Растения": {
        "Домашние животные": ["Собаки", "Кошки", "Птицы"],
        "Сельхоз животные": ["Коровы", "Овцы", "Лошади"],
        "Растения": ["Цветы", "Саженцы"]
    },
    "Детский мир": {
        "Игрушки": ["LEGO", "Машинки", "Куклы"],
        "Детская одежда": ["Для малышей", "Школьная форма"],
        "Коляски": ["2 в 1", "Прогулочные"]
    },
    "Строительство и Ремонт": {
        "Стройматериалы": ["Цемент", "Кирпич", "Гипсокартон"],
        "Инструменты": ["Перфораторы", "Шуруповерты"],
        "Окна и Двери": ["Пластиковые окна", "Входные двери"]
    },
    "Спорт и Музыка": {
        "Спорт": ["Тренажеры", "Велосипеды", "Единоборства"],
        "Музыка": ["Гитары", "Пианино", "Синтезаторы"]
    },
    "Красота": {
        "Парфюмерия": ["Мужская", "Женская"],
        "Косметика": ["Уход за лицом", "Макияж"]
    },
    "Отдам Даром": {
        "Вещи": ["Одежда", "Мебель"],
        "Животные": ["В добрые руки"]
    }
};

// --- ОБЪЯВЛЕНИЯ (ADS) ---

/** Получить все объявления из LocalStorage */
export function getAds() {
    try {
        const data = localStorage.getItem('ads');
        if (!data || data === "undefined" || data === "null") return []; 
        return JSON.parse(data);
    } catch (e) {
        console.error("Ошибка чтения базы объявлений:", e);
        return [];
    }
}

/** Сохранить весь массив объявлений (перезапись) */
export function saveAds(ads) {
    try {
        localStorage.setItem('ads', JSON.stringify(ads));
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            alert('Ошибка: Память браузера переполнена! Попробуйте загрузить меньше фото или уменьшить их размер.');
        }
        console.error("Ошибка записи объявлений:", e);
    }
}

/** Добавить одно новое объявление */
export function saveAd(newAd) {
    const ads = getAds();
    if (!newAd.id) newAd.id = Date.now();
    if (!newAd.createdAt) newAd.createdAt = new Date().toLocaleDateString('ru-RU');
    ads.push(newAd);
    saveAds(ads);
    return newAd.id;
}

/** Удалить объявление по ID */
export function deleteAd(adId) {
    let ads = getAds();
    ads = ads.filter(ad => ad.id !== Number(adId));
    saveAds(ads);
}

// --- ПОЛЬЗОВАТЕЛИ (USERS) ---

/** Получить список всех зарегистрированных пользователей */
export function getUsers() {
    try {
        const data = localStorage.getItem('users');
        if (!data || data === "undefined" || data === "null") return [];
        return JSON.parse(data);
    } catch (e) {
        console.error("Ошибка чтения списка пользователей:", e);
        return [];
    }
}

/** Сохранить список пользователей */
export function saveUsers(users) {
    try {
        localStorage.setItem('users', JSON.stringify(users));
    } catch (e) {
        console.error("Ошибка сохранения пользователей:", e);
    }
}

// --- СЕССИЯ (АВТОРИЗАЦИЯ) ---

/** Получить данные текущего вошедшего пользователя */
export function getCurrentUser() {
    try {
        const data = localStorage.getItem('currentUser');
        if (!data || data === "undefined" || data === "null") return null;
        return JSON.parse(data);
    } catch (e) {
        console.error("Ошибка получения текущего пользователя:", e);
        return null;
    }
}

/** Установить (войти) или удалить (выйти) текущего пользователя */
export function setCurrentUser(user) {
    if (user) {
        localStorage.setItem('currentUser', JSON.stringify(user));
    } else {
        localStorage.removeItem('currentUser');
    }
}

/** Псевдоним для совместимости с кодом регистрации */
export function saveCurrentUser(user) {
    setCurrentUser(user);
}

/** Функция выхода из системы */
export function logout() {
    localStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}